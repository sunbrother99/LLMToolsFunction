###gpt-4oç­‰åŸç”Ÿæ¥å£ç›´æ¥ç”¨äºå…¬å¸å†…éƒ¨å·¥å…·è°ƒç”¨å­˜åœ¨çš„é—®é¢˜

---


æˆ‘æƒ³ä»Šå¤©å»çœ‹ç”µå½±ï¼Œå¦‚æœå¤©æ°”ä¸é”™çš„è¯ï¼Œæ¨èä¸€å®¶é™„è¿‘è¯„åˆ†é«˜çš„ç”µå½±é™¢ã€‚

æä¾›çš„å¯é€‰å·¥å…·åˆ—è¡¨ä¸º

```json
tools = [
  {
    "name": "get_weather",
    "description": "è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯",
    "parameters": {
      "type": "object",
      "properties": {
        "city": {"type": "string", "description": "åŸå¸‚åç§°"},
        "date": {"type": "string", "description": "æ—¥æœŸ"},

      },
      "required": ["city","date"]
    }
  },
  {
    "name": "search_cinemas",
    "description": "æœç´¢è¯„åˆ†é«˜çš„ç”µå½±é™¢",
    "parameters": {
      "type": "object",
      "properties": {
        "location": {"type": "string"},
        "sort_by": {"type": "string", "enum": ["rating", "distance"]},
        "open_now": {"type": "boolean"}
      },
      "required": ["location", "sort_by", "open_now"]
    }
  }
]
```

ä»ç”¨æˆ·çš„queryä¸­æ— æ³•è§£æå‡ºcity,location,open_nowç­‰å‚æ•°ï¼Œä½†ç”±äºOpenAI function-calling ä½“ç³»ä¸­çš„ä¸€ä¸ªã€Œé»˜è®¤è¡Œä¸ºé™·é˜±ã€ï¼š

âœ… å®ƒçŸ¥é“å‚æ•°å¿…é¡»è¢«å¡«æ»¡
âŒ ä½†åœ¨æ²¡æœ‰ä¸Šä¸‹æ–‡æ—¶ï¼Œä¼šâ€œè‡ªä½œä¸»å¼ â€ç”Ÿæˆ "ä½ çš„åŸå¸‚" è¿™ç±»çŒœæµ‹æˆ–å ä½å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯è®©ä½ æ¥è¡¥å…¨æˆ–è€…ç›´æ¥è¡¥é—®ã€‚

å³ä½¿ä½ åœ¨promptåå¤å¼ºè°ƒä¸è¦è‡ªè¡Œå¡«å……å‚æ•°ï¼Œå®ƒä»ä¼šç”Ÿæˆå‡çš„å‚æ•°ã€‚

æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œç”¨4oæ¨¡å‹æ‰§è¡Œåï¼ŒLLMçš„è¾“å‡ºä¸º
```json
[
  {'role': 'system','content': 'ä½ æ˜¯ä¸€ä¸ªèƒ½æ ¹æ®ç”¨æˆ·éœ€æ±‚ä¸»åŠ¨è§„åˆ’ä»»åŠ¡æ­¥éª¤ã€åˆç†è°ƒç”¨å¤šä¸ªå·¥å…·çš„æ™ºèƒ½åŠ©æ‰‹ã€‚ä½ éœ€è¦åˆ¤æ–­æ˜¯å¦å…ˆè°ƒç”¨ä¸€ä¸ªå·¥å…·ï¼Œå†æ ¹æ®ç»“æœå†³å®šæ˜¯å¦è°ƒç”¨ä¸‹ä¸€ä¸ªå·¥å…·ã€‚'},
  {'role': 'user', 'content': 'æˆ‘æƒ³ä»Šå¤©å»çœ‹ç”µå½±ï¼Œå¦‚æœå¤©æ°”ä¸é”™çš„è¯ï¼Œæ¨èä¸€å®¶é™„è¿‘è¯„åˆ†é«˜çš„ç”µå½±é™¢ã€‚'},
  {'role': 'assistant', 'content': None,'tool_calls': [
    {'id': 'call_81ShbBPDOJCF2ZWTDYIvtQQs','type': 'function','function': {'name': 'get_weather', 'arguments': '{"city": "æ·±åœ³", "date": "2023-10-22"}'}},
    {'id': 'call_O0J5AedofEjAzuMZ99fgTRvO', 'type': 'function', 'function': {'name': 'search_cinemas', 'arguments': '{"location": "æ·±åœ³", "sort_by": "rating", "open_now": true}'}}
  ]
  }
]
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨LLMçš„è¾“å‡ºä¸­ï¼Œcityï¼šæ·±åœ³ï¼Œdateï¼š2023-10-22éƒ½æ˜¯LLMç¼–é€ çš„å‚æ•°ï¼Œå®é™…ç”¨æˆ·çš„åŸå¸‚ä¸ºåŒ—äº¬ï¼Œdateæ˜¯2024-04-27ã€‚

ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

ğŸŒ OpenAI çš„æ¨¡å‹è¡Œä¸ºï¼ˆGPT-4 / GPT-4oï¼‰ï¼š

çŸ¥é“ tools çš„ required å‚æ•°ï¼ˆä½ ä¼ äº† schemaï¼‰ï¼›

ç¼ºå°‘ä¸Šä¸‹æ–‡ä¹Ÿä¼šå¼ºè¡Œç”Ÿæˆå‚æ•°ï¼ˆå³ä½¿å€¼ä¸å¯ä¿¡ï¼‰ï¼›

ä¸ä¼šåœ¨å·¥å…·è°ƒç”¨é˜¶æ®µä¸»åŠ¨ã€Œç©ºç¼ºå­—æ®µã€æˆ–ã€Œè§¦å‘è¡¥é—®ã€ï¼›

å®ƒå®æ„¿çŒœä¸€ä¸ª"å‡çš„"å€¼ï¼Œä¹Ÿä¸ä¼šè®© arguments ç•™ç©ºï¼ˆå¦‚ nullï¼‰ï¼›

è§£å†³æ–¹æ¡ˆï¼š

è®©æ¨¡å‹åªè´Ÿè´£æå–â€œæ„å›¾ + æ‰€éœ€å‚æ•°åâ€

å·¥ç¨‹å¸ˆæ¥å†³å®šæ¯ä¸ªå‚æ•°æ˜¯å¦æœ‰å€¼ï¼Œå¹¶æ„é€  tool_call

å®ç°æ–¹å¼ï¼šä¸¤é˜¶æ®µæ„å›¾è¯†åˆ« + Tool è¡¥å…¨

ä½ åœ¨ prompt æˆ– system message ä¸­å‘Šè¯‰å®ƒï¼š

å¦‚æœä½ æ— æ³•ç¡®å®šæŸä¸ªå‚æ•°å€¼ï¼Œä¸è¦ç¼–é€ ï¼Œç›´æ¥è¿”å› null æˆ–ä¸è¦åŒ…å«è¯¥å­—æ®µã€‚

è®©å®ƒè¿”å›æ ¼å¼ç±»ä¼¼ï¼š

```json
{
  "tool": "get_weather",
  "args": {
    "city": null,
    "date": "2025-04-25"
  }
}
```

ç¤ºä¾‹promptï¼š

```json
ä½ æ˜¯ä¸€ä¸ªè´Ÿè´£è§„åˆ’ tool è°ƒç”¨çš„åŠ©æ‰‹ã€‚è¯·ä»ç”¨æˆ·çš„è¯·æ±‚ä¸­æå–å‡ºï¼š
- è°ƒç”¨å“ªä¸ªå·¥å…·ï¼ˆå·¥å…·åï¼‰
- å“ªäº›å‚æ•°æ˜¯æ˜ç¡®çš„ï¼ˆæä¾›å€¼ï¼‰
- å“ªäº›å‚æ•°æ˜¯ç¼ºå¤±çš„ï¼ˆè¿”å› nullï¼‰

ä¸è¦èƒ¡ä¹±çŒœæµ‹å‚æ•°å€¼ï¼Œå¦‚æœå€¼æ²¡æœ‰è¢«ç”¨æˆ·æ˜ç¡®æåˆ°ï¼Œå°±è¿”å› nullã€‚
```

âœ… ç¬¬äºŒæ­¥ï¼šåœ¨ç³»ç»Ÿä¸­ä½ æ¥å¤„ç†è¡¥å…¨é€»è¾‘
```python
def construct_final_tool_call(parsed, user_context, fallback):
    args = {}
    for k, v in parsed["args"].items():
        if v is not None:
            args[k] = v
        elif k in user_context:
            args[k] = user_context[k]
        elif k in fallback:
            args[k] = fallback[k]
        else:
            # ç¼ºå¤±ä¸”æ— æ³•è¡¥å…¨ï¼Œå¯æç¤ºç”¨æˆ·
            raise ValueError(f"å‚æ•° {k} ç¼ºå¤±ï¼Œæ— æ³•è¡¥å…¨")
    
    return {
        "name": parsed["tool"],
        "arguments": args
    }
```






